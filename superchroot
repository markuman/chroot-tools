#!/bin/bash
# WTFPL

set -e 

## functions
# ==========

set_chroot (){

        if [[ "$option" = "exit" ]]; then
		printf "trying to umount used directories from chroot option...\n\n"
		chroot_umount "$@"

        elif [[ "$option" = "proot" ]]; then
        	printf "forcing proot method...\n\n"
                proot -r $folder

        elif [[ "$option" = "fakechroot" ]]; then
        	printf "forcing fakechroot method...\n\n"
                export FAKECHROOT_EXCLUDE_PATH=/proc:/dev:/sys
                fakechroot -s fakeroot chroot $folder

        elif [[ "$option" = "systemd" ]]; then
        	printf "forcing systemd method...\n\n"
                systemd-nspawn -D $folder

        elif [[ "$option" = "chroot" ]]; then
        	printf "forcing chroot method...\n\n"
                mount -t devtmpfs /dev $folder/dev
                mount -t devpts /dev/pts $folder/dev/pts
                mount -t sysfs /sys $folder/sys
                mount -t proc /proc $folder/proc
                chroot $folder $terminal

	elif [[ "$option" = "arch" ]]; then
		printf "forcing arch-chroot method...\n\n"
		arch-chroot $folder

        else
                printf "unknown option\n"
        fi

}

super_chroot(){

	if [ "$UID" -ne 0 ]; then

                if which fakechroot >/dev/null; then
			printf "fakechroot found...\n"
                        export FAKECHROOT_EXCLUDE_PATH=/proc:/dev:/sys
                        fakechroot -s fakeroot chroot $folder

                elif which proot >/dev/null; then
			printf "proot found ...\n"
                        proot -r $folder

                else
                        printf "I can not find fakechroot nor proot, nor are root. Sorry, but I can\'t chroot.\n"
                fi
        else

                if which systemd-nspawn >/dev/null; then
                        systemd-nspawn -D $folder

		elif which arch-chroot >/dev/null; then
			arch-chroot $folder

                else
                        printf "\nRunning classic chroot with mount -t... \n\n"
			chroot_mount "$folder"
                        chroot $folder $terminal
                fi
        fi

}




chroot_mount() {

	mount proc "$folder/proc" -t proc -o nosuid,noexec,nodev &&
	mount sys "$folder/sys" -t sysfs -o nosuid,noexec,nodev,ro &&
	mount udev "$folder/dev" -t devtmpfs -o mode=0755,nosuid &&
	mount devpts "$folder/dev/pts" -t devpts -o mode=0620,gid=5,nosuid,noexec &&
	mount shm "$folder/dev/shm" -t tmpfs -o mode=1777,nosuid,nodev &&
	mount run "$folder/run" -t tmpfs -o nosuid,nodev,mode=0755 &&
	mount tmp "$folder/tmp" -t tmpfs -o mode=1777,strictatime,nodev,nosuid

}

chroot_umount() {

	printf "Trying to umount chroot folder ...\n"
	umount "$folder/proc"
	umount "$folder/sys"
	umount "$folder/dev"
	umount "$folder/dev/pts"
	umount "$folder/dev/shm"
	umount "$folder/run"
	umount "$folder/tmp"

}

print_help(){

	echo '
        superchroot <folder>
        superchroot [chroot-option] <folder>

        [chroot options]: systemd (root), chroot (root), arch (root), fakechroot, proot, exit (umount directories from chroot methode)


        EXAMPLES - force method
        ~$: su -c "superchroot systemd arch/"
        ~$: sudo superchroot chroot arch/
        ~$: superchroot proot arch/
        ~$: superchroot fakechroot arch/

        EXAMPLES - automaticaly best choice
        ~#: superchroot arch/
        ~$: superchroot arch/
	'

}

## Variable
## ========

terminal="/bin/bash"


## MAIN
## ====

if (("$#" == 1)); then

        if [[ "$1" = "--help" ]]; then
		print_help
		exit
		fi

	folder=$1
	super_chroot "$@"

elif (("$#" == 2)); then

	option=$1
	folder=$2
	set_chroot "$@"
else
        printf "Wrong usage!\n\n"
        print_help
	exit
fi

